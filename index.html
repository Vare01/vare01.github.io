<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shocking Math | Human Metrics Hub</title>
    <style>
        :root {
            --primary: #00ff88;
            --bg: #0b0f1a;
            --card: #161b2a;
            --text: #f8fafc;
            --sidebar-w: 280px;
            --accent: #3b82f6;
            --border: #2d334a;
            --input-bg: #0b0f1a;
        }

        /* Light Theme Variables */
        body.light-theme {
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #0f172a;
            --border: #e2e8f0;
            --input-bg: #f8fafc;
            --accent: #2563eb;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            transition: background 0.3s, color 0.3s;
        }

        /* Sidebar - Desktop */
        .sidebar {
            width: var(--sidebar-w);
            background: var(--card);
            border-right: 1px solid var(--border);
            display: flex; flex-direction: column;
            padding: 25px; flex-shrink: 0; z-index: 100;
        }

        .logo-container {
            margin-bottom: 25px;
            position: relative;
        }

        .logo {
            font-size: 1.4rem; font-weight: 900; color: var(--primary);
            letter-spacing: -1px;
            display: flex; align-items: center; gap: 10px;
            position: relative;
        }

        .santa-hat {
            position: absolute;
            top: -12px;
            left: 10px;
            width: 30px;
            transform: rotate(-15deg);
            pointer-events: none;
        }

        .beta-tag {
            font-size: 0.65rem;
            background: rgba(128, 128, 128, 0.1);
            color: #94a3b8;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            margin-top: 4px;
            display: inline-block;
        }

        .search-box {
            padding: 12px; background: var(--input-bg); border: 1px solid var(--border);
            border-radius: 10px; color: var(--text); margin-bottom: 20px;
            width: 100%; box-sizing: border-box; outline: none; font-size: 0.85rem;
        }

        .nav-list {
            list-style: none; padding: 0; margin: 0;
            overflow-y: auto; flex-grow: 1;
        }

        .nav-item {
            padding: 10px 14px; border-radius: 10px; cursor: pointer;
            margin-bottom: 6px; transition: all 0.2s ease;
            font-size: 0.85rem; color: #94a3b8;
            display: flex; align-items: center; gap: 10px;
        }

        .nav-item:hover { background: rgba(0, 255, 136, 0.05); color: var(--text); }
        .nav-item.active {
            background: var(--primary); color: #000; font-weight: 700;
        }

        /* Top Actions (Theme & Snow) */
        .top-actions {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 1001;
        }

        .action-btn {
            background: var(--card);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        .action-btn:hover { border-color: var(--primary); }

        /* Mobile Header */
        .mobile-header {
            display: none;
            width: 100%;
            background: var(--card);
            padding: 10px 15px;
            border-bottom: 1px solid var(--border);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            box-sizing: border-box;
            flex-direction: column;
            gap: 5px;
        }

        .mobile-top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .mobile-tool-select {
            background: var(--input-bg);
            color: var(--primary);
            border: 1px solid var(--primary);
            padding: 10px;
            border-radius: 10px;
            font-size: 0.95rem;
            outline: none;
            width: 100%;
            font-weight: 600;
        }

        /* Main Content */
        .main-content {
            flex-grow: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: flex-start;
            padding: 60px 20px 40px; overflow-y: auto; position: relative;
        }

        .lang-bar {
            display: flex; gap: 5px;
        }

        .sidebar .lang-bar {
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .lang-btn {
            background: var(--card); border: 1px solid var(--border); color: var(--text);
            padding: 6px 10px; border-radius: 8px; cursor: pointer;
            font-size: 0.75rem; font-weight: 600; flex: 1;
            text-align: center;
        }

        .lang-btn.active { border-color: var(--primary); color: var(--primary); background: rgba(0, 255, 136, 0.1); }

        .tool-card {
            background: var(--card); padding: 30px; border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1); width: 100%;
            max-width: 600px; border: 1px solid var(--border);
            margin-bottom: 40px;
            min-height: 350px;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 10;
        }

        h2 { margin: 0 0 10px 0; font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
        .tool-desc { color: #64748b; font-size: 0.85rem; margin-bottom: 25px; line-height: 1.4; }

        .input-row { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
        .input-group { flex: 1; min-width: 140px; }

        label {
            display: block; margin-bottom: 12px; font-size: 0.85rem;
            color: #94a3b8; text-transform: uppercase; font-weight: 800;
            letter-spacing: 0.5px;
        }

        input, select {
            width: 100%; padding: 14px; background: var(--input-bg);
            border: 1px solid var(--border); border-radius: 12px; color: var(--text);
            font-size: 1rem; box-sizing: border-box; transition: border 0.3s;
        }

        input:focus, select:focus { border-color: var(--primary); outline: none; }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: auto;
        }

        .calc-btn, .nav-btn {
            flex: 1; padding: 16px; background: var(--primary);
            color: #000; border: none; border-radius: 12px; font-weight: 800;
            cursor: pointer; text-transform: uppercase; font-size: 0.9rem;
        }

        .nav-btn.secondary {
            background: rgba(128, 128, 128, 0.1);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .ai-btn {
            background: var(--accent); color: white; padding: 18px;
            border-radius: 14px; font-weight: 800; border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 12px; 
            margin-top: 20px; width: 100%; font-size: 1.1rem;
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.2);
        }

        .result-container { margin-top: 30px; display: none; width: 100%; }
        .res-block {
            background: rgba(128, 128, 128, 0.05); border-radius: 16px;
            padding: 18px; margin-bottom: 12px; border: 1px solid var(--border);
        }

        .ai-block {
            background: rgba(59, 130, 246, 0.05); border: 1px solid var(--accent);
            border-left-width: 4px; padding: 18px; border-radius: 16px;
            margin-top: 15px; display: none;
        }

        .res-title, .ai-title { color: var(--primary); font-size: 0.65rem; font-weight: 900; text-transform: uppercase; margin-bottom: 5px; display: block; }
        .res-value { font-size: 1rem; font-weight: 500; line-height: 1.5; }
        .highlight { color: var(--primary); font-weight: 800; }

        .progress-container {
            width: 100%; height: 6px; background: var(--border);
            border-radius: 10px; margin-bottom: 30px; overflow: hidden;
        }
        .progress-bar {
            height: 100%; background: var(--primary); transition: width 0.4s ease;
        }

        /* Snow Canvas */
        #snow-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
            display: none;
        }

        /* Responsive UI */
        @media (max-width: 850px) {
            .sidebar { display: none; }
            .mobile-header { display: flex; }
            .main-content { padding-top: 140px; padding-left: 15px; padding-right: 15px; height: auto; overflow: visible; }
            body { height: auto; overflow-y: auto; }
            .tool-card { padding: 20px; margin-top: 0; }
            .top-actions { top: 110px; right: 15px; scale: 0.9; }
        }
    </style>
</head>
<body>

    <canvas id="snow-canvas"></canvas>

    <!-- Mobile Header -->
    <header class="mobile-header">
        <div class="mobile-top-bar">
            <div class="logo-container">
                <div class="logo">
                    <svg class="santa-hat" viewBox="0 0 100 100">
                        <path d="M20,50 Q50,0 80,50 L85,60 Q50,45 15,60 Z" fill="#ff4444" stroke="#fff" stroke-width="2"/>
                        <circle cx="85" cy="60" r="8" fill="#fff" />
                        <path d="M15,60 Q50,50 85,60 L85,70 Q50,60 15,70 Z" fill="#fff" />
                    </svg>
                    SHOCKING MATH ‚ö°
                </div>
                <div class="beta-tag">BETA v1.0</div>
            </div>
            <div class="lang-bar">
                <button class="lang-btn active" id="m-lang-en" onclick="changeLang('en')">EN</button>
                <button class="lang-btn" id="m-lang-sr" onclick="changeLang('sr')">SR</button>
            </div>
        </div>
        <select class="mobile-tool-select" id="mobile-nav" onchange="selectMobileTool(this.value)"></select>
    </header>

    <!-- Desktop Sidebar -->
    <aside class="sidebar">
        <div class="logo-container">
            <div class="logo">
                <svg class="santa-hat" viewBox="0 0 100 100">
                    <path d="M20,50 Q50,0 80,50 L85,60 Q50,45 15,60 Z" fill="#ff4444" stroke="#fff" stroke-width="2"/>
                    <circle cx="85" cy="60" r="8" fill="#fff" />
                    <path d="M15,60 Q50,50 85,60 L85,70 Q50,60 15,70 Z" fill="#fff" />
                </svg>
                SHOCKING MATH ‚ö°
            </div>
            <div class="beta-tag">BETA v1.0</div>
        </div>
        <input type="text" class="search-box" id="search" placeholder="Pretra≈æi..." onkeyup="filterTools()">
        <ul class="nav-list" id="nav-list"></ul>
        <div class="lang-bar">
            <button class="lang-btn active" id="d-lang-en" onclick="changeLang('en')">EN</button>
            <button class="lang-btn" id="d-lang-sr" onclick="changeLang('sr')">SR</button>
        </div>
    </aside>

    <main class="main-content">
        <div class="top-actions">
            <button class="action-btn" onclick="toggleSnow()" id="snow-toggle-btn">
                <span>‚ùÑÔ∏è</span> <span class="btn-text">Snow Off</span>
            </button>
            <button class="action-btn" onclick="toggleTheme()" id="theme-toggle-btn">
                <span>üåô</span> <span class="btn-text">Dark</span>
            </button>
        </div>
        <div id="tool-view" style="width: 100%; display: flex; justify-content: center;"></div>
    </main>

<script>
    let activeLang = 'en';
    let activeTool = "lifestyle";
    let quizStep = 0;
    let quizData = {};
    let isDarkMode = true;
    let isSnowing = false;

    const toolDefinitions = [
        { id: "lifestyle", emoji: "üß™", inputs: ["age", "smoke", "packs", "smoke_start", "drink", "alcohol_freq", "drink_start", "diet", "consume_pork"] },
        { id: "human", emoji: "üë§", inputs: ["age"] },
        { id: "oxygen", emoji: "üå¨Ô∏è", inputs: ["age"] },
        { id: "scroll", emoji: "üì±", inputs: ["age", "start", "hours"] },
        { id: "coffee", emoji: "‚òï", inputs: ["age", "start", "daily"] },
        { id: "perfume", emoji: "üß¥", inputs: ["size", "price", "sprays", "freq"] },
        { id: "exam", emoji: "üìö", inputs: ["pages", "pph", "hours"] },
        { id: "toilet", emoji: "üöΩ", inputs: ["min", "daily"] },
        { id: "sleep", emoji: "üò¥", inputs: ["shours"] },
        { id: "books", emoji: "üìñ", inputs: ["pday"] },
        { id: "bezos", emoji: "üí∞", inputs: ["salary"] },
        { id: "pizza", emoji: "üçï", inputs: ["monthly"] },
        { id: "commute", emoji: "üöó", inputs: ["chours", "cyears"] },
        { id: "words", emoji: "üó£Ô∏è", inputs: ["age"] },
        { id: "sitting", emoji: "ü™ë", inputs: ["shours_day", "syears"] },
        { id: "waiting", emoji: "‚è≥", inputs: ["age"] }
    ];

    const translations = {
        en: {
            nav: ["Lifestyle Quiz", "Human Body Stats", "Oxygen Factory", "Scroll Everest", "Coffee Ocean", "Perfume Value", "Exam Timer", "Toilet Warp", "Sleep Debt", "Book Worm", "Bezos vs You", "Pizza Surface", "Commute Life", "Words Library", "Sitting Life", "Waiting Line"],
            h: ["Lifestyle Shock Quiz", "Human Body Facts", "Oxygen Factory", "Scroll Distance", "Coffee Ocean", "Perfume Value", "Exam Prep", "Toilet Time", "Sleep Debt", "Book Worm", "The Bezos Gap", "Pizza Surface", "Traffic Trap", "Talking Library", "The Chair Trap", "Queue Specialist"],
            d: ["Discover the total volume of your habits.", "Biological impact of your existence.", "Amount of oxygen you've consumed and CO2 produced.", "Vertical distance you've scrolled.", "The literal ocean of caffeine consumed.", "True cost of smelling good.", "Study sessions based on volume.", "Life spent on the porcelain throne.", "Cost of staying awake vs rest.", "Knowledge volume in books.", "Billionaire vs your annual wage.", "Total surface of dough eaten.", "Time lost in traffic jams.", "Library of words you've spoken.", "Impact of a sedentary lifestyle.", "Time spent waiting in queues."],
            lbl: {
                age: "What is your current age?", smoke: "Do you smoke cigarettes?", packs: "How many packs do you smoke per day?", smoke_start: "At what age did you start smoking?",
                drink: "Do you consume alcohol?", alcohol_freq: "How many drinks do you have per week?", drink_start: "At what age did you start drinking?",
                diet: "What is your primary diet?", consume_pork: "Do you consume pork?",
                start: "Started at", hours: "Hours/Day", daily: "Times/Day", size: "Size (ml)", price: "Price (‚Ç¨)",
                sprays: "Sprays", freq: "Days/Week", pages: "Pages", pph: "Pages/h", min: "Min/Session",
                shours: "Sleep Hours", pday: "Pages/Day", monthly: "Pizzas/Month", salary: "Salary (‚Ç¨)", 
                chours: "Hours/Day", cyears: "Years", shours_day: "Hours Sitting", syears: "Years",
                btn: "Calculate üöÄ", ai_btn: "Get ‚ú® AI Insight", ai_loading: "Analyzing...", ai_title: "AI Analysis ‚ú®",
                soon: "Feature coming soon! üöÄ",
                opt_yes: "Yes", opt_no: "No", opt_normal: "Normal (Everything)", opt_vegan: "Vegan", opt_veg: "Vegetarian",
                next: "Next", back: "Back",
                snowOn: "Snow On", snowOff: "Snow Off", themeDark: "Dark", themeLight: "Light"
            },
            res_t: ["The Shock üò±", "The Math üìä"],
            facts: ["Heartbeat", "Breaths", "Hair", "Feces", "Urine", "Skin"],
            units: ["beats", "times", "km", "kg", "L", "kg"],
            ofacts: ["Oxygen Consumed", "CO2 Produced", "Trees Required"],
            ounits: ["liters", "kg", "trees"],
            life_res: ["Smoking Impact", "Alcohol Impact", "Diet Impact"]
        },
        sr: {
            nav: ["≈Ωivotni kviz", "Ljudsko telo", "Fabrika kiseonika", "Scroll Everest", "Okean kafe", "Cena parfema", "Ispit tajmer", "WC vreme", "Dug spavanja", "ƒåitaƒç knjiga", "Bezos i ti", "Povr≈°ina pice", "≈Ωivot u putu", "Biblioteka reƒçi", "≈Ωivot u stolici", "Red ƒçekanja"],
            h: ["≈†ok kviz navika", "ƒåinjenice o telu", "Fabrika kiseonika", "Scroll kilometra≈æa", "Okean kafe", "Vrednost parfema", "Spremanje ispita", "WC vremenska ma≈°ina", "Dug spavanja", "ƒåitaƒç knjiga", "Bezosov ponor", "Povr≈°ina pice", "Zemlja u gu≈ævi", "Govorna biblioteka", "Zamka stolice", "Specijalista za redove"],
            d: ["Otkrij pravu zapreminu tvojih navika.", "Izraƒçunaj svoj biolo≈°ki uticaj do sada.", "Koliƒçina kiseonika koju si potro≈°io i CO2 koji si proizveo.", "Koliko si visoko skrolovao vertikalno.", "Doslovni okean kofeina koji si popio.", "Prava cena tvog dobrog mirisa.", "Isplaniraj uƒçenje na osnovu strana.", "Vreme provedeno na porcelanskom tronu.", "Cena nespavanja u odnosu na odmor.", "Zapremina znanja u knjigama.", "Koliko brzo Bezos zaradi tvoju platu.", "Ukupna povr≈°ina testa koju si pojeo.", "Vreme izgubljeno u saobraƒáaju.", "Biblioteka reƒçi koje si izgovorio.", "Fiziƒçki uticaj sedenja.", "Vreme provedeno u redovima."],
            lbl: {
                age: "Koliko ima≈° godina?", smoke: "Da li pu≈°i≈° cigarete?", packs: "Koliko pakli dnevno pu≈°i≈°?", smoke_start: "Sa koliko godina si poƒçeo da pu≈°i≈°?",
                drink: "Da li konzumira≈° alkohol?", alcohol_freq: "Koliko piƒáa popije≈° nedeljno?", drink_start: "Sa koliko godina si poƒçeo da pije≈°?",
                diet: "Tip ishrane", consume_pork: "Da li konzumira≈° svinjetinu?",
                start: "Poƒçeo sa", hours: "Sati dnevno", daily: "Dnevno puta", size: "Veliƒçina (ml)", price: "Cena (‚Ç¨)",
                sprays: "Prskanja", freq: "Dana/Nedeljno", pages: "Ukupno strana", pph: "Strana/h", min: "Min/Sesiji",
                shours: "Sati sna", pday: "Strana/Dan", monthly: "Pica meseƒçno", salary: "Plata (‚Ç¨)",
                chours: "Sati/Dan", cyears: "Godina puta", shours_day: "Sati sedenja", syears: "Godina sedenja",
                btn: "Izraƒçunaj üöÄ", ai_btn: "Zatra≈æi ‚ú® AI Uvid", ai_loading: "Analiziram...", ai_title: "AI Analiza ‚ú®",
                soon: "Funkcija sti≈æe uskoro! üöÄ",
                opt_yes: "Da", opt_no: "Ne", opt_normal: "Normalna (sve)", opt_vegan: "Vegan", opt_veg: "Vegetarijanac",
                next: "Dalje", back: "Nazad",
                snowOn: "Sneg On", snowOff: "Sneg Off", themeDark: "Tamna", themeLight: "Svetla"
            },
            res_t: ["≈†ok podatak üò±", "Matematika üìä"],
            facts: ["Otkucaji srca", "Udisaji", "Rast kose", "Izmet", "Urin", "Mrtva ko≈æa"],
            units: ["otkucaja", "puta", "km", "kg", "L", "kg"],
            ofacts: ["Potro≈°en kiseonik", "Proizveden CO2", "Potrebno drveƒáa"],
            ounits: ["litara", "kg", "stabala"],
            life_res: ["Uticaj pu≈°enja", "Uticaj alkohola", "Uticaj ishrane"]
        }
    };

    function formatNumber(n) {
        return new Intl.NumberFormat('de-DE').format(Math.floor(n));
    }

    function changeLang(l) {
        activeLang = l;
        document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`d-lang-${l}`).classList.add('active');
        document.getElementById(`m-lang-${l}`).classList.add('active');
        updateActionButtons();
        refreshSidebar();
        renderActiveTool();
    }

    function toggleTheme() {
        isDarkMode = !isDarkMode;
        document.body.classList.toggle('light-theme', !isDarkMode);
        updateActionButtons();
    }

    function updateActionButtons() {
        const d = translations[activeLang] || translations['en'];
        const themeBtn = document.getElementById('theme-toggle-btn');
        const snowBtn = document.getElementById('snow-toggle-btn');

        themeBtn.querySelector('.btn-text').innerText = isDarkMode ? d.lbl.themeDark : d.lbl.themeLight;
        themeBtn.querySelector('span:first-child').innerText = isDarkMode ? 'üåô' : '‚òÄÔ∏è';

        snowBtn.querySelector('.btn-text').innerText = isSnowing ? d.lbl.snowOn : d.lbl.snowOff;
        snowBtn.querySelector('span:first-child').innerText = isSnowing ? '‚ùÑÔ∏è' : 'üå´Ô∏è';
    }

    function selectMobileTool(val) {
        activeTool = val;
        quizStep = 0;
        quizData = {};
        refreshSidebar();
        renderActiveTool();
    }

    function refreshSidebar(filter = "") {
        const d = translations[activeLang] || translations['en'];
        const list = document.getElementById('nav-list');
        const mobileNav = document.getElementById('mobile-nav');
        
        list.innerHTML = "";
        mobileNav.innerHTML = "";

        toolDefinitions.forEach((tool, i) => {
            const name = d.nav[i];
            if (name.toLowerCase().includes(filter.toLowerCase())) {
                const li = document.createElement('li');
                li.className = `nav-item ${tool.id === activeTool ? 'active' : ''}`;
                li.innerHTML = `<span>${tool.emoji}</span> ${name}`;
                li.onclick = () => { activeTool = tool.id; quizStep = 0; quizData = {}; refreshSidebar(filter); renderActiveTool(); };
                list.appendChild(li);
            }
            const opt = document.createElement('option');
            opt.value = tool.id;
            opt.innerText = `${tool.emoji} ${name}`;
            opt.selected = tool.id === activeTool;
            mobileNav.appendChild(opt);
        });
    }

    function renderActiveTool() {
        if (activeTool === 'lifestyle') {
            renderLifestyleQuiz();
            return;
        }

        const toolIdx = toolDefinitions.findIndex(t => t.id === activeTool);
        const tool = toolDefinitions[toolIdx];
        const d = translations[activeLang] || translations['en'];
        const view = document.getElementById('tool-view');
        
        let inputsHtml = "";
        for (let i = 0; i < tool.inputs.length; i++) {
            const key = tool.inputs[i];
            if (i % 2 === 0) inputsHtml += '<div class="input-row">';
            inputsHtml += `<div class="input-group"><label>${d.lbl[key]}</label><input type="text" id="in-${key}" value="${formatNumber(getDefaultValue(key))}" oninput="handleInput(event)"></div>`;
            if (i % 2 === 1 || i === tool.inputs.length - 1) inputsHtml += '</div>';
        }

        view.innerHTML = `
            <div class="tool-card active">
                <h2>${tool.emoji} ${d.h[toolIdx]}</h2>
                <p class="tool-desc">${d.d[toolIdx]}</p>
                ${inputsHtml}
                <button class="calc-btn" onclick="runCalculation()">${d.lbl.btn}</button>
                <div class="result-container" id="res-box"></div>
            </div>
        `;
    }

    function renderLifestyleQuiz() {
        const d = translations[activeLang] || translations['en'];
        const view = document.getElementById('tool-view');
        const tool = toolDefinitions[0];
        const steps = tool.inputs;
        const currentKey = steps[quizStep];
        const progress = ((quizStep + 1) / steps.length) * 100;

        let inputElement = "";
        if (["smoke", "drink", "consume_pork"].includes(currentKey)) {
            inputElement = `<select id="in-quiz-${currentKey}"><option value="yes" ${quizData[currentKey] === 'yes' ? 'selected' : ''}>${d.lbl.opt_yes}</option><option value="no" ${quizData[currentKey] === 'no' ? 'selected' : ''}>${d.lbl.opt_no}</option></select>`;
        } else if (currentKey === 'diet') {
            inputElement = `<select id="in-quiz-${currentKey}">
                <option value="normal" ${quizData[currentKey] === 'normal' ? 'selected' : ''}>${d.lbl.opt_normal}</option>
                <option value="vegan" ${quizData[currentKey] === 'vegan' ? 'selected' : ''}>${d.lbl.opt_vegan}</option>
                <option value="veg" ${quizData[currentKey] === 'veg' ? 'selected' : ''}>${d.lbl.opt_veg}</option>
            </select>`;
        } else {
            inputElement = `<input type="number" id="in-quiz-${currentKey}" value="${quizData[currentKey] || getDefaultValue(currentKey)}">`;
        }

        view.innerHTML = `
            <div class="tool-card active">
                <div class="progress-container"><div class="progress-bar" style="width: ${progress}%"></div></div>
                <h2>${tool.emoji} ${d.h[0]}</h2>
                <p class="tool-desc">${d.d[0]}</p>
                <div style="margin-bottom: 30px;">
                    <label>${d.lbl[currentKey]}</label>
                    ${inputElement}
                </div>
                <div class="btn-group">
                    ${quizStep > 0 ? `<button class="nav-btn secondary" onclick="prevQuizStep()">${d.lbl.back}</button>` : ''}
                    <button class="nav-btn" onclick="nextQuizStep()">${quizStep === steps.length - 1 ? d.lbl.btn : d.lbl.next}</button>
                </div>
                <div class="result-container" id="res-box"></div>
            </div>
        `;
    }

    function nextQuizStep() {
        const tool = toolDefinitions[0];
        const steps = tool.inputs;
        const currentKey = steps[quizStep];
        const val = document.getElementById(`in-quiz-${currentKey}`).value;
        quizData[currentKey] = val;

        if (currentKey === 'smoke' && val === 'no') { quizStep = 4; } 
        else if (currentKey === 'drink' && val === 'no') { quizStep = 7; } 
        else { quizStep++; }

        if (quizStep >= steps.length) { quizStep = steps.length - 1; runCalculation(); } 
        else { renderActiveTool(); }
    }

    function prevQuizStep() {
        if (quizStep === 7 && quizData['drink'] === 'no') { quizStep = 4; } 
        else if (quizStep === 4 && quizData['smoke'] === 'no') { quizStep = 1; } 
        else { quizStep--; }
        if (quizStep < 0) quizStep = 0;
        renderActiveTool();
    }

    function handleInput(e) {
        let val = e.target.value.replace(/\D/g, "");
        if (val === "") { e.target.value = ""; return; }
        e.target.value = new Intl.NumberFormat('de-DE').format(parseInt(val));
    }

    function getDefaultValue(key) {
        const defaults = { age: 25, packs: 1, smoke_start: 18, alcohol_freq: 5, drink_start: 18, start: 14, hours: 4, daily: 2, size: 100, price: 150, sprays: 5, freq: 7, pages: 300, pph: 6, min: 20, shours: 6, pday: 25, monthly: 4, salary: 45000, chours: 1, cyears: 15, shours_day: 8, syears: 10 };
        return defaults[key] || 0;
    }

    function runCalculation() {
        const d = translations[activeLang] || translations['en'];

        if (activeTool === 'lifestyle') {
            const age = parseFloat(quizData.age) || 1;
            const res = [];
            if (quizData.smoke === 'yes') {
                const sYears = Math.max(0, age - parseFloat(quizData.smoke_start));
                const packs = parseFloat(quizData.packs);
                const totalCigs = Math.round(sYears * 365.25 * packs * 20);
                const totalMoney = Math.round(sYears * 365.25 * packs * 5.45);
                res.push({ icon: "üö¨", label: d.life_res[0], value: activeLang === 'sr' ? `Popu≈°eno <span class="highlight">${formatNumber(totalCigs)}</span> cigareta. Potro≈°eno <span class="highlight">${formatNumber(totalMoney)} ‚Ç¨</span>.` : `Smoked <span class="highlight">${formatNumber(totalCigs)}</span> cigarettes. Spent <span class="highlight">${formatNumber(totalMoney)} ‚Ç¨</span>.` });
            }
            if (quizData.drink === 'yes') {
                const dYears = Math.max(0, age - parseFloat(quizData.drink_start));
                const totalDrinks = Math.round(dYears * 52.17 * parseFloat(quizData.alcohol_freq));
                const totalLiters = Math.round(totalDrinks * 0.45 * 10) / 10; 
                res.push({ icon: "üç∫", label: d.life_res[1], value: activeLang === 'sr' ? `Konzumirano <span class="highlight">${formatNumber(totalLiters)} litara</span> alkohola.` : `Consumed <span class="highlight">${formatNumber(totalLiters)} liters</span> of alcohol.` });
            }
            let dietDesc = "";
            const totalMeat = Math.round(age * 365.25 * 0.228);
            if (quizData.diet === 'vegan') dietDesc = activeLang === 'sr' ? `Spasio si <span class="highlight">${formatNumber(age * 365)}</span> ≈æivotinja.` : `Saved <span class="highlight">${formatNumber(age * 365)}</span> animals.`;
            else if (quizData.diet === 'veg') dietDesc = activeLang === 'sr' ? `Po≈°tedeo si <span class="highlight">${formatNumber(age * 182)}</span> ≈æivotinja.` : `Spared <span class="highlight">${formatNumber(age * 182)}</span> animals.`;
            else dietDesc = activeLang === 'sr' ? `Pojeo si <span class="highlight">${formatNumber(totalMeat)} kg</span> mesa.` : `Ate <span class="highlight">${formatNumber(totalMeat)} kg</span> of meat.`;
            if (quizData.consume_pork === 'no') dietDesc += activeLang === 'sr' ? ` Izbegao si <span class="highlight">~${formatNumber(age * 44.5)} kg</span> svinjetine.` : ` Avoided <span class="highlight">~${formatNumber(age * 44.5)} kg</span> of pork.`;
            res.push({ icon: "üçΩÔ∏è", label: d.life_res[2], value: dietDesc });
            renderHumanResults(res);
            return;
        }

        const tool = toolDefinitions.find(t => t.id === activeTool);
        const vals = {};
        tool.inputs.forEach(id => { vals[id] = parseFloat(document.getElementById(`in-${id}`).value.replace(/\./g, "")) || 0; });

        if (activeTool === 'human') {
            const age = vals.age || 1;
            renderHumanResults([{ icon: "‚ù§Ô∏è", label: d.facts[0], value: formatNumber(age * 365.25 * 24 * 60 * 72), unit: d.units[0] }, { icon: "üå¨Ô∏è", label: d.facts[1], value: formatNumber(age * 365.25 * 24 * 60 * 14), unit: d.units[1] }, { icon: "üêç", label: d.facts[5], value: (age * 0.85).toFixed(1), unit: d.units[5] }]);
        } else if (activeTool === 'oxygen') {
            const age = vals.age || 1;
            const co2 = age * 365.25 * 1.05;
            renderHumanResults([{ icon: "ü´Å", label: d.ofacts[0], value: formatNumber(age * 365.25 * 550), unit: d.ounits[0] }, { icon: "üè≠", label: d.ofacts[1], value: formatNumber(co2), unit: d.ounits[1] }, { icon: "üå≥", label: d.ofacts[2], value: formatNumber(Math.ceil(co2 / 21)), unit: d.ounits[2] }]);
        } else {
            renderResultsArea(activeTool, activeTool, ["Processing...", "Results generated."]);
        }
    }

    function renderHumanResults(data) {
        const container = document.getElementById(`res-box`);
        container.innerHTML = "";
        data.forEach(item => {
            const div = document.createElement('div');
            div.className = "res-block";
            div.style.display = "flex"; div.style.alignItems = "center"; div.style.gap = "15px";
            div.innerHTML = `<span style="font-size: 1.5rem;">${item.icon}</span><div><span class="res-title">${item.label}</span><div class="res-value">${item.value} ${item.unit || ''}</div></div>`;
            container.appendChild(div);
        });
        addAIBtn(container);
        container.style.display = "block";
    }

    function renderResultsArea(id, type, dataStrings) {
        const container = document.getElementById(`res-box`);
        const d = translations[activeLang] || translations['en'];
        container.innerHTML = "";
        dataStrings.forEach((text, i) => {
            const div = document.createElement('div');
            div.className = "res-block";
            div.innerHTML = `<span class="res-title">${d.res_t[i] || "Result"}</span><div class="res-value">${text}</div>`;
            container.appendChild(div);
        });
        addAIBtn(container);
        container.style.display = "block";
    }

    function addAIBtn(container) {
        const d = translations[activeLang] || translations['en'];
        const aiBtn = document.createElement('button');
        aiBtn.className = "ai-btn";
        aiBtn.innerHTML = `<span class="btn-label">${d.lbl.ai_btn}</span>`;
        aiBtn.onclick = () => {
            let aiBox = document.getElementById('ai-box');
            if (!aiBox) {
                aiBox = document.createElement('div');
                aiBox.id = `ai-box`;
                aiBox.className = "ai-block";
                container.appendChild(aiBox);
            }
            aiBox.style.display = "block";
            aiBox.innerHTML = `<span class="ai-title">${d.lbl.ai_title}</span><div class="res-value" id="ai-val">${d.lbl.soon}</div>`;
        };
        container.appendChild(aiBtn);
    }

    // Snow logic
    const canvas = document.getElementById('snow-canvas');
    const ctx = canvas.getContext('2d');
    let snowflakes = [];
    function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    function createSnowflakes() { snowflakes = []; for (let i = 0; i < 150; i++) { snowflakes.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, radius: Math.random() * 4 + 1, speed: Math.random() * 1 + 0.5, wind: Math.random() * 0.5 - 0.25 }); } }
    function updateSnow() { if (!isSnowing) return; ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.fillStyle = isDarkMode ? "white" : "#cbd5e1"; ctx.beginPath(); snowflakes.forEach(f => { ctx.moveTo(f.x, f.y); ctx.arc(f.x, f.y, f.radius, 0, Math.PI * 2); f.y += f.speed; f.x += f.wind; if (f.y > canvas.height) f.y = -10; if (f.x > canvas.width) f.x = 0; if (f.x < 0) f.x = canvas.width; }); ctx.fill(); requestAnimationFrame(updateSnow); }
    function toggleSnow() { isSnowing = !isSnowing; canvas.style.display = isSnowing ? 'block' : 'none'; if (isSnowing) { resizeCanvas(); createSnowflakes(); updateSnow(); } updateActionButtons(); }
    window.addEventListener('resize', resizeCanvas);
    refreshSidebar();
    renderActiveTool();
    updateActionButtons();
</script>
</body>
</html>
